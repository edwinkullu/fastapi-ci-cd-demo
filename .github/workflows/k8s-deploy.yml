name: Deploy to Kubernetes

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3

    - name: Check kubeconfig
      run: |
        echo "${{ secrets.KUBE_CONFIG }}" > kubeconfig.yaml
        cat kubeconfig.yaml
        kubectl --kubeconfig=kubeconfig.yaml config view
        kubectl --kubeconfig=kubeconfig.yaml config current-context

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG }}" > kubeconfig.yaml
        kubectl --kubeconfig=kubeconfig.yaml config use-context kubernetes-admin@piramal-cluster.local
        kubectl --kubeconfig=kubeconfig.yaml config current-context

    - name: Verify Kubernetes Cluster Connection
      run: |
        kubectl --kubeconfig=kubeconfig.yaml cluster-info

    - name: Apply Kubernetes manifests
      run: |
        kubectl --kubeconfig=kubeconfig.yaml apply -f kubernetes/deployment.yaml --validate=false
        kubectl --kubeconfig=kubeconfig.yaml apply -f kubernetes/service.yaml --validate=false
        kubectl --kubeconfig=kubeconfig.yaml apply -f kubernetes/ingress.yaml --validate=false
