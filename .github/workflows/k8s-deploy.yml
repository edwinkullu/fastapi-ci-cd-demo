name: Deploy to EKS Cluster

on:
  push:
    branches:
      - main
    paths:
      - 'kubernetes/**'
      - 'Dockerfile'
      - 'app/**'

jobs:
  deploy:
    name: Deploy FastAPI to EKS
    runs-on: ubuntu-latest
    needs: terraform  # Ensure Terraform EKS setup runs first
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up AWS CLI
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        region: ${{ secrets.TF_VAR_region }}

    - name: Set up Kubeconfig
      run: aws eks update-kubeconfig --region ${{ secrets.TF_VAR_region }} --name fastapi-cluster

    - name: Build Docker Image and Push to DockerHub
      run: |
        docker build -t <your-dockerhub-username>/fastapi:latest .
        docker push <your-dockerhub-username>/fastapi:latest

    - name: Apply Kubernetes Manifests
      run: |
        kubectl apply -f kubernetes/clusterissuer.yaml
        kubectl apply -f kubernetes/deployment.yaml
        kubectl apply -f kubernetes/service.yaml
        kubectl apply -f kubernetes/ingress.yaml

    - name: Wait for the ingress to be available
      run: |
        kubectl wait --for=condition=available --timeout=600s deployment/fastapi-app
        kubectl get svc fastapi-service
